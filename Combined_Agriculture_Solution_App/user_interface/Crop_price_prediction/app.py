from flask import Flask, render_template_string, request
import torch
import joblib

randomforest = joblib.load("crop_price_prediction.rn")
encode = {'ALABAMA': 0, 'COTTON, COTTONSEED': 0, 'COTTON, UPLAND': 1, 'SOYBEANS': 2, 'ARIZONA': 1, 'BROCCOLI': 3, 'BROCCOLI, FRESH MARKET': 4, 'CAULIFLOWER': 5, 'ARKANSAS': 2, 'CALIFORNIA': 3, 'ALMONDS': 6, 'APPLES': 7, 'APPLES, FRESH MARKET': 8, 'APPLES, PROCESSING': 9, 'APRICOTS': 10, 'ASPARAGUS': 11, 'ASPARAGUS, FRESH MARKET': 12, 'AVOCADOS': 13, 'BLUEBERRIES, TAME': 14, 'BLUEBERRIES, TAME, FRESH MARKET': 15, 'BLUEBERRIES, TAME, PROCESSING': 16, 'BROCCOLI, PROCESSING': 17, 'CARROTS': 18, 'CHERRIES, SWEET': 19, 'CHERRIES, SWEET, FRESH MARKET': 20, 'CHERRIES, SWEET, PROCESSING': 21, 'CUCUMBERS': 22, 'CUCUMBERS, FRESH MARKET': 23, 'CUCUMBERS, PROCESSING': 24, 'GRAPES': 25, 'GRAPES, FRESH MARKET': 26, 'GRAPES, PROCESSING': 27, 'GRAPES, RAISIN TYPE': 28, 'GRAPES, RAISIN TYPE, FRESH MARKET': 29, 'GRAPES, RAISIN TYPE, PROCESSING': 30, 'GRAPES, TABLE TYPE': 31, 'GRAPES, TABLE TYPE, FRESH MARKET': 32, 'GRAPES, TABLE TYPE, PROCESSING': 33, 'GRAPES, WINE TYPE': 34, 'GRAPES, WINE TYPE, PROCESSING': 35, 'KIWIFRUIT': 36, 'KIWIFRUIT, FRESH MARKET': 37, 'NECTARINES': 38, 'OLIVES': 39, 'OLIVES, PROCESSING': 40, 'OLIVES, PROCESSING, CANNED': 41, 'OLIVES, PROCESSING, CRUSHED': 42, 'OLIVES, PROCESSING, LIMITED': 43, 'OLIVES, PROCESSING, UNDERSIZED': 44, 'ONIONS, DRY': 45, 'ONIONS, DRY, FRESH MARKET': 46, 'ONIONS, DRY, PROCESSING': 47, 'PEACHES': 48, 'PEACHES, CLINGSTONE': 49, 'PEACHES, CLINGSTONE, PROCESSING': 50, 'PEACHES, FREESTONE': 51, 'PEACHES, FREESTONE, FRESH MARKET': 52, 'PEACHES, FREESTONE, PROCESSING': 53, 'PEACHES, FRESH MARKET': 54, 'PEACHES, PROCESSING': 55, 'PEARS': 56, 'PEARS, FRESH MARKET': 57, 'PEARS, PROCESSING': 58, 'PLUMS': 59, 'PLUMS, FRESH MARKET': 60, 'PLUMS, PROCESSING': 61, 'PUMPKINS': 62, 'PUMPKINS, FRESH MARKET': 63, 'RASPBERRIES': 64, 'SQUASH': 65, 'STRAWBERRIES': 66, 'SUNFLOWER': 67, 'SUNFLOWER, NON-OIL TYPE': 68, 'SUNFLOWER, OIL TYPE': 69, 'WALNUTS, ENGLISH': 70, 'COLORADO': 4, 'DELAWARE': 5, 'FLORIDA': 6, 'SQUASH, FRESH MARKET': 71, 'GEORGIA': 7, 'HAWAII': 8, 'IDAHO': 9, 'ILLINOIS': 10, 'PUMPKINS, PROCESSING': 72, 'INDIANA': 11, 'IOWA': 12, 'KANSAS': 13, 'KENTUCKY': 14, 'LOUISIANA': 15, 'MAINE': 16, 'BLUEBERRIES, WILD': 73, 'BLUEBERRIES, WILD, FRESH MARKET': 74, 'BLUEBERRIES, WILD, PROCESSING': 75, 'MARYLAND': 17, 'MASSACHUSETTS': 18, 'CRANBERRIES': 76, 'CRANBERRIES, FRESH MARKET': 77, 'CRANBERRIES, PROCESSING': 78, 'MICHIGAN': 19, 'ASPARAGUS, PROCESSING': 79, 'CHERRIES, TART': 80, 'CHERRIES, TART, FRESH MARKET': 81, 'CHERRIES, TART, PROCESSING': 82, 'SQUASH, PROCESSING': 83, 'MINNESOTA': 20, 'MISSISSIPPI': 21, 'MISSOURI': 22, 'NEBRASKA': 23, 'NEW JERSEY': 24, 'NEW MEXICO': 25, 'NEW YORK': 26, 'NORTH CAROLINA': 27, 'NORTH DAKOTA': 28, 'OHIO': 29, 'OKLAHOMA': 30, 'OREGON': 31, 'PENNSYLVANIA': 32, 'SOUTH CAROLINA': 33, 'SOUTH DAKOTA': 34, 'TENNESSEE': 35, 'TEXAS': 36, 'UTAH': 37, 'VIRGINIA': 38, 'WASHINGTON': 39, 'CARROTS, FRESH MARKET': 84, 'CARROTS, PROCESSING': 85, 'GRAPES, JUICE TYPE': 86, 'GRAPES, JUICE TYPE, PROCESSING': 87, 'WISCONSIN': 40, 'GRAPES, WINE TYPE, FRESH MARKET': 88, 'KIWIFRUIT, PROCESSING': 89, 'STRAWBERRIES, FRESH MARKET': 90, 'STRAWBERRIES, PROCESSING': 91, 'SUGARBEETS': 92, 'MONTANA': 41, 'GRAPES, JUICE TYPE, FRESH MARKET': 93, 'WEST VIRGINIA': 42, 'WYOMING': 43, 'CAULIFLOWER, FRESH MARKET': 94, 'APRICOTS, PROCESSING, CANNED': 95, 'AVOCADOS, FRESH MARKET': 96, 'AVOCADOS, PROCESSING': 97, 'CAULIFLOWER, PROCESSING': 98, 'GRAPES, PROCESSING, DRIED': 99, 'GRAPES, PROCESSING, WINE': 100, 'GRAPES, RAISIN TYPE, PROCESSING, CANNED': 101, 'GRAPES, RAISIN TYPE, PROCESSING, DRIED': 102, 'GRAPES, RAISIN TYPE, PROCESSING, WINE': 103, 'GRAPES, TABLE TYPE, PROCESSING, DRIED': 104, 'GRAPES, TABLE TYPE, PROCESSING, WINE': 105, 'GRAPES, WINE TYPE, PROCESSING, WINE': 106, 'OLIVES, UNDERSIZED': 107, 'PEACHES, FREESTONE, PROCESSING, (EXCL DRIED)': 108, 'PEARS, (EXCL BARTLETT)': 109, 'PEARS, (EXCL BARTLETT), FRESH MARKET': 110, 'PEARS, BARTLETT': 111, 'PEARS, BARTLETT, FRESH MARKET': 112, 'RASPBERRIES, BLACK': 113, 'RASPBERRIES, FRESH MARKET': 114, 'RASPBERRIES, PROCESSING': 115, 'RASPBERRIES, RED': 116, 'CONNECTICUT': 44, 'APPLES, PROCESSING, CANNED': 117, 'APPLES, PROCESSING, JUICE': 118, 'CHERRIES, TART, PROCESSING, CANNED': 119, 'CHERRIES, TART, PROCESSING, FROZEN': 120, 'GRAPES, PROCESSING, JUICE': 121, 'GRAPES, JUICE TYPE, CONCORD': 122, 'BOYSENBERRIES': 123, 'BOYSENBERRIES, FRESH MARKET': 124, 'BOYSENBERRIES, PROCESSING': 125, 'VERMONT': 45, 'APRICOTS, FRESH MARKET': 126, 'APRICOTS, PROCESSING': 127, 'APRICOTS, PROCESSING, DRIED': 128, 'PEARS, (EXCL BARTLETT), PROCESSING, (EXCL DRIED)': 129, 'PEARS, BARTLETT, PROCESSING, (EXCL DRIED)': 130, 'RASPBERRIES, BLACK, FRESH MARKET': 131, 'RASPBERRIES, RED, FRESH MARKET': 132, 'RASPBERRIES, RED, PROCESSING': 133, 'CHERRIES, SWEET, PROCESSING, BRINED': 134, 'RASPBERRIES, BLACK, PROCESSING': 135, 'COTTON, PIMA': 136, 'CHERRIES, SWEET, PROCESSING, CANNED': 137, 'ONIONS, DRY, SPRING': 138, 'ONIONS, DRY, SUMMER, NON-STORAGE': 139, 'ONIONS, DRY, SUMMER, STORAGE': 140, 'ONIONS, DRY, SUMMER, STORAGE, PROCESSING': 141, 'PEACHES, CLINGSTONE, PROCESSING, CANNED': 142, 'PEACHES, FREESTONE, PROCESSING, DRIED': 143, 'PEACHES, FREESTONE, PROCESSING, FROZEN': 144, 'CUCUMBERS, PROCESSING, PICKLES': 145, 'NEW HAMPSHIRE': 46, 'RHODE ISLAND': 47, 'CHERRIES, TART, PROCESSING, (EXCL CANNED & FROZEN)': 146, 'CHERRIES, SWEET, PROCESSING, (EXCL CANNED & BRINED)': 147, 'APPLES, PROCESSING, OTHER': 148, 'NECTARINES, FRESH MARKET': 149, 'PEACHES, PROCESSING, DRIED': 150, 'NEVADA': 48}


encode_reverse = {v: k for k, v in encode.items()}

# Flask app
app = Flask(__name__)

template = """
<html>
<body>
    <form method="POST">
        <label for="location">Select Location:</label>
        <select id="location" name="location" required>
            <option value="" disabled selected>Select a location</option>
            {% for loc in locations %}
            <option value="{{ loc }}">{{ loc }}</option>
            {% endfor %}
        </select>
        <br><br>

        <label for="crop">Select Crop:</label>
        <select id="crop" name="crop" required>
            <option value="" disabled selected>Select a crop</option>
            {% for crop in crops %}
            <option value="{{ crop }}">{{ crop }}</option>
            {% endfor %}
        </select>
        <br><br>

        <button type="submit">Submit</button>
    </form>

    {% if prediction_rf %}
        <h2>Predicted Price</h2>
        
        <h3>Random Forest Prediction:</h3>
        <p>{{ prediction_rf }}</p>
    {% endif %}
</body>
</html>
"""

@app.route('/', methods=['GET', 'POST'])
def home():
    crops = ['COTTON, COTTONSEED', 'COTTON, UPLAND', 'SOYBEANS', 'BROCCOLI', 'BROCCOLI, FRESH MARKET', 'CAULIFLOWER', 'ALMONDS', 'APPLES', 'APPLES, FRESH MARKET', 'APPLES, PROCESSING', 'APRICOTS', 'ASPARAGUS', 'ASPARAGUS, FRESH MARKET', 'AVOCADOS', 'BLUEBERRIES, TAME', 'BLUEBERRIES, TAME, FRESH MARKET', 'BLUEBERRIES, TAME, PROCESSING', 'BROCCOLI, PROCESSING', 'CARROTS', 'CHERRIES, SWEET', 'CHERRIES, SWEET, FRESH MARKET', 'CHERRIES, SWEET, PROCESSING', 'CUCUMBERS', 'CUCUMBERS, FRESH MARKET', 'CUCUMBERS, PROCESSING', 'GRAPES', 'GRAPES, FRESH MARKET', 'GRAPES, PROCESSING', 'GRAPES, RAISIN TYPE', 'GRAPES, RAISIN TYPE, FRESH MARKET', 'GRAPES, RAISIN TYPE, PROCESSING', 'GRAPES, TABLE TYPE', 'GRAPES, TABLE TYPE, FRESH MARKET', 'GRAPES, TABLE TYPE, PROCESSING', 'GRAPES, WINE TYPE', 'GRAPES, WINE TYPE, PROCESSING', 'KIWIFRUIT', 'KIWIFRUIT, FRESH MARKET', 'NECTARINES', 'OLIVES', 'OLIVES, PROCESSING', 'OLIVES, PROCESSING, CANNED', 'OLIVES, PROCESSING, CRUSHED', 'OLIVES, PROCESSING, LIMITED', 'OLIVES, PROCESSING, UNDERSIZED', 'ONIONS, DRY', 'ONIONS, DRY, FRESH MARKET', 'ONIONS, DRY, PROCESSING', 'PEACHES', 'PEACHES, CLINGSTONE', 'PEACHES, CLINGSTONE, PROCESSING', 'PEACHES, FREESTONE', 'PEACHES, FREESTONE, FRESH MARKET', 'PEACHES, FREESTONE, PROCESSING', 'PEACHES, FRESH MARKET', 'PEACHES, PROCESSING', 'PEARS', 'PEARS, FRESH MARKET', 'PEARS, PROCESSING', 'PLUMS', 'PLUMS, FRESH MARKET', 'PLUMS, PROCESSING', 'PUMPKINS', 'PUMPKINS, FRESH MARKET', 'RASPBERRIES', 'SQUASH', 'STRAWBERRIES', 'SUNFLOWER', 'SUNFLOWER, NON-OIL TYPE', 'SUNFLOWER, OIL TYPE', 'WALNUTS, ENGLISH', 'SQUASH, FRESH MARKET', 'PUMPKINS, PROCESSING', 'BLUEBERRIES, WILD', 'BLUEBERRIES, WILD, FRESH MARKET', 'BLUEBERRIES, WILD, PROCESSING', 'CRANBERRIES', 'CRANBERRIES, FRESH MARKET', 'CRANBERRIES, PROCESSING', 'ASPARAGUS, PROCESSING', 'CHERRIES, TART', 'CHERRIES, TART, FRESH MARKET', 'CHERRIES, TART, PROCESSING', 'SQUASH, PROCESSING', 'CARROTS, FRESH MARKET', 'CARROTS, PROCESSING', 'GRAPES, JUICE TYPE', 'GRAPES, JUICE TYPE, PROCESSING', 'GRAPES, WINE TYPE, FRESH MARKET', 'KIWIFRUIT, PROCESSING', 'STRAWBERRIES, FRESH MARKET', 'STRAWBERRIES, PROCESSING', 'SUGARBEETS', 'GRAPES, JUICE TYPE, FRESH MARKET', 'CAULIFLOWER, FRESH MARKET', 'APRICOTS, PROCESSING, CANNED', 'AVOCADOS, FRESH MARKET', 'AVOCADOS, PROCESSING', 'CAULIFLOWER, PROCESSING', 'GRAPES, PROCESSING, DRIED', 'GRAPES, PROCESSING, WINE', 'GRAPES, RAISIN TYPE, PROCESSING, CANNED', 'GRAPES, RAISIN TYPE, PROCESSING, DRIED', 'GRAPES, RAISIN TYPE, PROCESSING, WINE', 'GRAPES, TABLE TYPE, PROCESSING, DRIED', 'GRAPES, TABLE TYPE, PROCESSING, WINE', 'GRAPES, WINE TYPE, PROCESSING, WINE', 'OLIVES, UNDERSIZED', 'PEACHES, FREESTONE, PROCESSING, (EXCL DRIED)', 'PEARS, (EXCL BARTLETT)', 'PEARS, (EXCL BARTLETT), FRESH MARKET', 'PEARS, BARTLETT', 'PEARS, BARTLETT, FRESH MARKET', 'RASPBERRIES, BLACK', 'RASPBERRIES, FRESH MARKET', 'RASPBERRIES, PROCESSING', 'RASPBERRIES, RED', 'APPLES, PROCESSING, CANNED', 'APPLES, PROCESSING, JUICE', 'CHERRIES, TART, PROCESSING, CANNED', 'CHERRIES, TART, PROCESSING, FROZEN', 'GRAPES, PROCESSING, JUICE', 'GRAPES, JUICE TYPE, CONCORD', 'BOYSENBERRIES', 'BOYSENBERRIES, FRESH MARKET', 'BOYSENBERRIES, PROCESSING', 'APRICOTS, FRESH MARKET', 'APRICOTS, PROCESSING', 'APRICOTS, PROCESSING, DRIED', 'PEARS, (EXCL BARTLETT), PROCESSING, (EXCL DRIED)', 'PEARS, BARTLETT, PROCESSING, (EXCL DRIED)', 'RASPBERRIES, BLACK, FRESH MARKET', 'RASPBERRIES, RED, FRESH MARKET', 'RASPBERRIES, RED, PROCESSING', 'CHERRIES, SWEET, PROCESSING, BRINED', 'RASPBERRIES, BLACK, PROCESSING', 'COTTON, PIMA', 'CHERRIES, SWEET, PROCESSING, CANNED', 'ONIONS, DRY, SPRING', 'ONIONS, DRY, SUMMER, NON-STORAGE', 'ONIONS, DRY, SUMMER, STORAGE', 'ONIONS, DRY, SUMMER, STORAGE, PROCESSING', 'PEACHES, CLINGSTONE, PROCESSING, CANNED', 'PEACHES, FREESTONE, PROCESSING, DRIED', 'PEACHES, FREESTONE, PROCESSING, FROZEN', 'CUCUMBERS, PROCESSING, PICKLES', 'CHERRIES, TART, PROCESSING, (EXCL CANNED & FROZEN)', 'CHERRIES, SWEET, PROCESSING, (EXCL CANNED & BRINED)', 'APPLES, PROCESSING, OTHER', 'NECTARINES, FRESH MARKET', 'PEACHES, PROCESSING, DRIED']
    locations = ['ALABAMA', 'ARIZONA', 'ARKANSAS', 'CALIFORNIA', 'COLORADO', 'DELAWARE', 'FLORIDA', 'GEORGIA', 'HAWAII', 'IDAHO', 'ILLINOIS', 'INDIANA', 'IOWA', 'KANSAS', 'KENTUCKY', 'LOUISIANA', 'MAINE', 'MARYLAND', 'MASSACHUSETTS', 'MICHIGAN', 'MINNESOTA', 'MISSISSIPPI', 'MISSOURI', 'NEBRASKA', 'NEW JERSEY', 'NEW MEXICO', 'NEW YORK', 'NORTH CAROLINA', 'NORTH DAKOTA', 'OHIO', 'OKLAHOMA', 'OREGON', 'PENNSYLVANIA', 'SOUTH CAROLINA', 'SOUTH DAKOTA', 'TENNESSEE', 'TEXAS', 'UTAH', 'VIRGINIA', 'WASHINGTON', 'WISCONSIN', 'MONTANA', 'WEST VIRGINIA', 'WYOMING', 'CONNECTICUT', 'VERMONT', 'NEW HAMPSHIRE', 'RHODE ISLAND', 'NEVADA']

    prediction_rf = None
    if request.method == 'POST':
        location = request.form['location']
        crop = request.form['crop']

        if location in encode and crop in encode:
            loc_encoded = encode[location]
            crop_encoded = encode[crop]

            inp = torch.tensor([loc_encoded, crop_encoded], dtype=torch.float32)

            rf_output = randomforest.predict(inp.view(1, -1).numpy())
            prediction_rf = rf_output
            print(prediction_rf)

    return render_template_string(template, locations=locations, crops=crops, prediction_rf=prediction_rf)

if __name__ == '__main__':
    app.run(debug=True)
